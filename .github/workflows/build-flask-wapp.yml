# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions
# More info on Python, GitHub Actions, and Azure App Service: https://aka.ms/python-webapps-actions

name: Build and deploy Python app to Azure Web App - brk-flask-app-wapp

on:
  workflow_dispatch:
    inputs:
      webapp_name:
        description: "Azure Web App name"
        required: false
        type: string
      repo_name:
        description: "Repository name to match in tag value (optional)"
        required: false
        type: string
      tag_key:
        description: "Tag key used for lookup when webapp_name is not provided"
        required: false
        default: "repo"
        type: string
      tag_value:
        description: "Explicit tag value override for lookup (optional)"
        required: false
        type: string
      resource_group:
        description: "Azure Resource Group for the target web app (Note: if not deployed via ARM, the RG name may not follow the naming convention, so provide this input to ensure correct resolution)"
        required: false
        type: string
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read #This is required for actions/checkout

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python version
        uses: actions/setup-python@v5
        with:
          python-version: "3.14"

      # ðŸ› ï¸ Local Build Section (Optional)
      # The following section in your workflow is designed to catch build issues early on the client side, before deployment. This can be helpful for debugging and validation. However, if this step significantly increases deployment time and early detection is not critical for your workflow, you may remove this section to streamline the deployment process.
      - name: Create and Start virtual environment and Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # By default, when you enable GitHub CI/CD integration through the Azure portal, the platform automatically sets the SCM_DO_BUILD_DURING_DEPLOYMENT application setting to true. This triggers the use of Oryx, a build engine that handles application compilation and dependency installation (e.g., pip install) directly on the platform during deployment. Hence, we exclude the antenv virtual environment directory from the deployment artifact to reduce the payload size.
      - name: Upload artifact for deployment jobs
        uses: actions/upload-artifact@v4
        with:
          name: python-app
          path: |
            app/
            requirements.txt

      # ðŸš« Opting Out of Oryx Build
      # If you prefer to disable the Oryx build process during deployment, follow these steps:
      # 1. Remove the SCM_DO_BUILD_DURING_DEPLOYMENT app setting from your Azure App Service Environment variables.
      # 2. Refer to sample workflows for alternative deployment strategies: https://github.com/Azure/actions-workflow-samples/tree/master/AppService

  deploy:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      id-token: write #This is required for requesting the JWT
      contents: read #This is required for actions/checkout

    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: python-app

      - name: Create GitHub App token
        id: app
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.GH_APPLICATION_ID }}
          private-key: ${{ secrets.GH_APP_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app.outputs.token }}

      - name: Azure login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Resolve web app name (dispatch > repo var > tag)
        id: resolveapp
        run: |
          INPUT_APP_NAME="${{ github.event.inputs.webapp_name || '' }}"
          INPUT_REPO_NAME="${{ github.event.inputs.repo_name || '' }}"
          INPUT_TAG_KEY="${{ github.event.inputs.tag_key || 'repo' }}"
          INPUT_TAG_VALUE="${{ github.event.inputs.tag_value || '' }}"
          REPO_APP_NAME="${{ vars.WEBAPP_NAME || '' }}"
          DEFAULT_REPO_NAME="${GITHUB_REPOSITORY#*/}"

          if [ -n "$INPUT_TAG_VALUE" ]; then
            EFFECTIVE_TAG_VALUE="$INPUT_TAG_VALUE"
          elif [ -n "$INPUT_REPO_NAME" ]; then
            EFFECTIVE_TAG_VALUE="$INPUT_REPO_NAME"
          else
            EFFECTIVE_TAG_VALUE="$DEFAULT_REPO_NAME"
          fi

          if [ -n "$INPUT_APP_NAME" ]; then
            RESOLVED_APP_NAME="$INPUT_APP_NAME"
            echo "Using workflow_dispatch input webapp_name: $RESOLVED_APP_NAME"
          elif [ -n "$REPO_APP_NAME" ]; then
            RESOLVED_APP_NAME="$REPO_APP_NAME"
            echo "Using repository variable WEBAPP_NAME: $RESOLVED_APP_NAME"
          else
            QUERY="[?tags.${INPUT_TAG_KEY}=='${EFFECTIVE_TAG_VALUE}'].name | [0]"
            RESOLVED_APP_NAME=$(az webapp list --query "$QUERY" -o tsv)
            if [ -n "$RESOLVED_APP_NAME" ]; then
              echo "Using web app found by tag $INPUT_TAG_KEY=$EFFECTIVE_TAG_VALUE: $RESOLVED_APP_NAME"
            fi
          fi

          if [ -z "$RESOLVED_APP_NAME" ]; then
            echo "No web app name resolved. Provide workflow_dispatch input webapp_name, set repository variable WEBAPP_NAME, or tag a web app with $INPUT_TAG_KEY=$EFFECTIVE_TAG_VALUE." >&2
            exit 1
          fi

          echo "app_name=$RESOLVED_APP_NAME" >> $GITHUB_OUTPUT

      - name: Preflight Azure target validation
        id: preflight
        run: |
          APP_NAME="${{ steps.resolveapp.outputs.app_name }}"
          INPUT_RESOURCE_GROUP="${{ github.event.inputs.resource_group || '' }}"
          ACTIVE_SUBSCRIPTION_ID=$(az account show --query id -o tsv)

          echo "Azure subscription in workflow context: $ACTIVE_SUBSCRIPTION_ID"
          echo "Input resource group: $INPUT_RESOURCE_GROUP"

          if [ -z "$INPUT_RESOURCE_GROUP" ]; then
            REQUIRED_RESOURCE_GROUP="${APP_NAME}-rg"
            echo "No resource_group input provided. Defaulting to: $REQUIRED_RESOURCE_GROUP"
          else
            REQUIRED_RESOURCE_GROUP="$INPUT_RESOURCE_GROUP"
            echo "Using provided resource_group: $REQUIRED_RESOURCE_GROUP"
          fi

          WEBAPP_SHOW_OUTPUT=$(az webapp show --name "$APP_NAME" --resource-group "$REQUIRED_RESOURCE_GROUP" --query name -o tsv 2>&1) || WEBAPP_SHOW_EXIT=$?
          WEBAPP_SHOW_EXIT=${WEBAPP_SHOW_EXIT:-0}

          if [ "$WEBAPP_SHOW_EXIT" -ne 0 ]; then
            if echo "$WEBAPP_SHOW_OUTPUT" | grep -Eiq "AuthorizationFailed|does not have authorization"; then
              echo "::error::Azure identity does not have permission to read web app '$APP_NAME' in resource group '$REQUIRED_RESOURCE_GROUP'."
              echo "::error::Grant at least Reader on the target resource group (or Web App), then rerun."
              echo "::error::Identity object id is shown in the Azure CLI error above."
              exit 1
            fi

            echo "::error::Web app '$APP_NAME' was not found in resource group '$REQUIRED_RESOURCE_GROUP' under subscription '$ACTIVE_SUBSCRIPTION_ID'."
            echo "::error::If your ARM deployment used a different RG name, provide workflow_dispatch input resource_group explicitly."
            echo "::error::Also verify AZURE_SUBSCRIPTION_ID, AZURE_TENANT_ID, and AZURE_CLIENT_ID."
            exit 1
          fi

          echo "Resolved resource group: $REQUIRED_RESOURCE_GROUP"
          echo "resource_group=$REQUIRED_RESOURCE_GROUP" >> $GITHUB_OUTPUT

      - name: Discover Azure IDs
        id: discover_ids
        run: |
          APP_NAME="${{ steps.resolveapp.outputs.app_name }}"
          RESOURCE_GROUP="${{ steps.preflight.outputs.resource_group }}"

          SUBSCRIPTION_ID=$(az account show --query id -o tsv 2>/dev/null || true)
          TENANT_ID=$(az account show --query tenantId -o tsv 2>/dev/null || true)

          UAMI_RESOURCE_ID=$(az webapp identity show \
            --name "$APP_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --query "keys(userAssignedIdentities)[0]" -o tsv 2>/dev/null || true)

          if [ -z "$UAMI_RESOURCE_ID" ]; then
            UAMI_RESOURCE_ID=$(az identity show \
              --name "${APP_NAME}-oidc-mi" \
              --resource-group "$RESOURCE_GROUP" \
              --query id -o tsv 2>/dev/null || true)
          fi

          CLIENT_ID=""
          if [ -n "$UAMI_RESOURCE_ID" ]; then
            CLIENT_ID=$(az identity show --ids "$UAMI_RESOURCE_ID" --query clientId -o tsv 2>/dev/null || true)
          fi

          echo "client_id=$CLIENT_ID" >> $GITHUB_OUTPUT
          echo "subscription_id=$SUBSCRIPTION_ID" >> $GITHUB_OUTPUT
          echo "tenant_id=$TENANT_ID" >> $GITHUB_OUTPUT

      - name: Set repo secrets for Azure credentials (if discovered)
        env:
          GH_TOKEN: ${{ steps.app.outputs.token }}
          CLIENT_ID: ${{ steps.discover_ids.outputs.client_id }}
          SUBSCRIPTION_ID: ${{ steps.discover_ids.outputs.subscription_id }}
          TENANT_ID: ${{ steps.discover_ids.outputs.tenant_id }}
        run: |
          if ! command -v gh >/dev/null 2>&1; then
            echo "gh CLI not available on runner; skipping secret updates."
            exit 0
          fi

          if [ -n "$CLIENT_ID" ]; then
            gh secret set AZURE_CLIENT_ID --body "$CLIENT_ID" --repo "${{ github.repository }}" || true
            echo "AZURE_CLIENT_ID updated"
          else
            echo "AZURE_CLIENT_ID not found; skipping"
          fi

          if [ -n "$SUBSCRIPTION_ID" ]; then
            gh secret set AZURE_SUBSCRIPTION_ID --body "$SUBSCRIPTION_ID" --repo "${{ github.repository }}" || true
            echo "AZURE_SUBSCRIPTION_ID updated"
          else
            echo "AZURE_SUBSCRIPTION_ID not found; skipping"
          fi

          if [ -n "$TENANT_ID" ]; then
            gh secret set AZURE_TENANT_ID --body "$TENANT_ID" --repo "${{ github.repository }}" || true
            echo "AZURE_TENANT_ID updated"
          else
            echo "AZURE_TENANT_ID not found; skipping"
          fi

      - name: Configure startup command (Gunicorn)
        run: |
          APP_NAME="${{ steps.resolveapp.outputs.app_name }}"
          RESOURCE_GROUP="${{ steps.preflight.outputs.resource_group }}"

          CURRENT_BUILD_SETTING=$(az webapp config appsettings list \
            --name "$APP_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --query "[?name=='SCM_DO_BUILD_DURING_DEPLOYMENT'].value | [0]" -o tsv)
          CURRENT_ORYX_SETTING=$(az webapp config appsettings list \
            --name "$APP_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --query "[?name=='ENABLE_ORYX_BUILD'].value | [0]" -o tsv)
          CURRENT_RUN_FROM_PACKAGE=$(az webapp config appsettings list \
            --name "$APP_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --query "[?name=='WEBSITE_RUN_FROM_PACKAGE'].value | [0]" -o tsv)

          if [ "$CURRENT_BUILD_SETTING" = "true" ] && [ "$CURRENT_ORYX_SETTING" = "true" ] && [ "$CURRENT_RUN_FROM_PACKAGE" = "0" ]; then
            echo "Build app settings already configured for Oryx"
          else
            if az webapp config appsettings set \
              --name "$APP_NAME" \
              --resource-group "$RESOURCE_GROUP" \
              --settings SCM_DO_BUILD_DURING_DEPLOYMENT=true ENABLE_ORYX_BUILD=true WEBSITE_RUN_FROM_PACKAGE=0 >/dev/null; then
              echo "Build app settings updated for Oryx"
            else
              echo "::error::Unable to set required build app settings (SCM_DO_BUILD_DURING_DEPLOYMENT, ENABLE_ORYX_BUILD, WEBSITE_RUN_FROM_PACKAGE)."
              echo "::error::Grant Microsoft.Web/sites/config/write permission to deployment identity and rerun."
              exit 1
            fi
          fi

          if az webapp config set \
            --name "$APP_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --startup-file "gunicorn --bind=0.0.0.0 --timeout 600 app.main:app"; then
            echo "Startup command configured for $APP_NAME"
          else
            echo "Warning: Unable to update startup command for $APP_NAME (likely missing Microsoft.Web/sites/config permissions). Continuing deploy."
          fi

      - name: "Deploy to Azure Web App"
        uses: azure/webapps-deploy@v3
        id: deploy-to-webapp
        with:
          app-name: ${{ steps.resolveapp.outputs.app_name }}
          slot-name: "Production"
          package: .
