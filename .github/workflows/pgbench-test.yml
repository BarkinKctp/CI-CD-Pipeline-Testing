name: Testing pgbench branch prefix

on:
    workflow_dispatch:
        inputs:
            webapp_name:
                description: "Azure Web App name"
                required: false
                type: string
            resource_group:
                description: "Azure Resource Group for the target web app (Note: if not deployed via ARM, the RG name may not follow the naming convention, so provide this input to ensure correct resolution)"
                required: false
                type: string
    push:
        branches:
            - pgbench/*
    pull_request:
        branches:
            - pgbench/*

jobs:
    build:
        runs-on: ubuntu-latest
        permissions:
            contents: read

        steps:
            - uses: actions/checkout@v4

            - name: Set up Python version
              uses: actions/setup-python@v5
              with:
                  python-version: "3.14"

            - name: Create and Start virtual environment and Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt

            - name: Upload artifact for deployment jobs
              uses: actions/upload-artifact@v4
              with:
                  name: python-app
                  path: |
                      app/
                      requirements.txt

    deploy:
        runs-on: ubuntu-latest
        needs: build
        permissions:
            id-token: write
            contents: read

        steps:
            - name: Create GitHub App token
              id: app
              uses: actions/create-github-app-token@v1
              with:
                  app-id: ${{ vars.GH_APPLICATION_ID }}
                  private-key: ${{ secrets.GH_APP_KEY }}
                  owner: ${{ github.repository_owner }}

            - name: Checkout
              uses: actions/checkout@v4
              with:
                  token: ${{ steps.app.outputs.token }}
                  clean: false

            - name: Download artifact from build job
              uses: actions/download-artifact@v4
              with:
                  name: python-app
                  path: deploy_pkg

            - name: Azure login
              uses: azure/login@v2
              with:
                  client-id: ${{ secrets.AZURE_CLIENT_ID }}
                  tenant-id: ${{ secrets.AZURE_TENANT_ID }}
                  subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

            - name: Resolve web app name (dispatch > repo var > tag)
              id: resolveapp
              run: |
                  INPUT_APP_NAME="${{ github.event.inputs.webapp_name || '' }}"
                  REPO_APP_NAME="${{ vars.WEBAPP_NAME || '' }}"
                  TAG_KEY="repo"
                  TAG_VALUE="${GITHUB_REPOSITORY#*/}"

                  if [ -n "$INPUT_APP_NAME" ]; then
                    RESOLVED_APP_NAME="$INPUT_APP_NAME"
                    echo "Using workflow_dispatch input webapp_name: $RESOLVED_APP_NAME"
                  elif [ -n "$REPO_APP_NAME" ]; then
                    RESOLVED_APP_NAME="$REPO_APP_NAME"
                    echo "Using repository variable WEBAPP_NAME: $RESOLVED_APP_NAME"
                  else
                    QUERY="[?tags.${TAG_KEY}=='${TAG_VALUE}'].name | [0]"
                    RESOLVED_APP_NAME=$(az webapp list --query "$QUERY" -o tsv)
                    if [ -n "$RESOLVED_APP_NAME" ]; then
                      echo "Using web app found by tag $TAG_KEY=$TAG_VALUE: $RESOLVED_APP_NAME"
                    fi
                  fi

                  if [ -z "$RESOLVED_APP_NAME" ]; then
                    echo "No web app name resolved. Provide workflow_dispatch input webapp_name, set repository variable WEBAPP_NAME, or tag a web app with $TAG_KEY=$TAG_VALUE." >&2
                    exit 1
                  fi

                  echo "app_name=$RESOLVED_APP_NAME" >> $GITHUB_OUTPUT

            - name: Preflight Azure target validation
              id: preflight
              run: |
                  APP_NAME="${{ steps.resolveapp.outputs.app_name }}"
                  INPUT_RESOURCE_GROUP="${{ github.event.inputs.resource_group || '' }}"
                  ACTIVE_SUBSCRIPTION_ID=$(az account show --query id -o tsv)

                  echo "Azure subscription in workflow context: $ACTIVE_SUBSCRIPTION_ID"
                  echo "Input resource group: $INPUT_RESOURCE_GROUP"

                  if [ -z "$INPUT_RESOURCE_GROUP" ]; then
                    REQUIRED_RESOURCE_GROUP="${APP_NAME}-rg"
                    echo "No resource_group input provided. Defaulting to: $REQUIRED_RESOURCE_GROUP"
                  else
                    REQUIRED_RESOURCE_GROUP="$INPUT_RESOURCE_GROUP"
                    echo "Using provided resource_group: $REQUIRED_RESOURCE_GROUP"
                  fi

                  WEBAPP_SHOW_OUTPUT=$(az webapp show --name "$APP_NAME" --resource-group "$REQUIRED_RESOURCE_GROUP" --query name -o tsv 2>&1) || WEBAPP_SHOW_EXIT=$?
                  WEBAPP_SHOW_EXIT=${WEBAPP_SHOW_EXIT:-0}

                  if [ "$WEBAPP_SHOW_EXIT" -ne 0 ]; then
                    if echo "$WEBAPP_SHOW_OUTPUT" | grep -Eiq "AuthorizationFailed|does not have authorization"; then
                      echo "::error::Azure identity does not have permission to read web app '$APP_NAME' in resource group '$REQUIRED_RESOURCE_GROUP'."
                      echo "::error::Grant at least Reader on the target resource group (or Web App), then rerun."
                      echo "::error::Identity object id is shown in the Azure CLI error above."
                      exit 1
                    fi

                    echo "::error::Web app '$APP_NAME' was not found in resource group '$REQUIRED_RESOURCE_GROUP' under subscription '$ACTIVE_SUBSCRIPTION_ID'."
                    echo "::error::If your ARM deployment used a different RG name, provide workflow_dispatch input resource_group explicitly."
                    echo "::error::Also verify AZURE_SUBSCRIPTION_ID, AZURE_TENANT_ID, and AZURE_CLIENT_ID."
                    exit 1
                  fi

                  echo "Resolved resource group: $REQUIRED_RESOURCE_GROUP"
                  echo "resource_group=$REQUIRED_RESOURCE_GROUP" >> $GITHUB_OUTPUT

            - name: Configure startup command (Gunicorn)
              run: |
                  APP_NAME="${{ steps.resolveapp.outputs.app_name }}"
                  RESOURCE_GROUP="${{ steps.preflight.outputs.resource_group }}"

                  for i in {1..10}; do
                    echo "Setting startup command (attempt $i)..."
                    if az webapp config set \
                      --name "$APP_NAME" \
                      --resource-group "$RESOURCE_GROUP" \
                      --startup-file "gunicorn --bind=0.0.0.0 --timeout 600 app.main:app"; then
                      echo "Startup command configured for $APP_NAME"
                      break
                    fi

                    if [ "$i" -eq 10 ]; then
                      echo "::error::Failed to set startup command for $APP_NAME after retries."
                      exit 1
                    fi

                    sleep 10
                  done

                  if az webapp restart --name "$APP_NAME" --resource-group "$RESOURCE_GROUP"; then
                    echo "Web app restarted after startup command update"
                  else
                    echo "Warning: Unable to restart web app after startup command update. Continuing deploy."
                  fi

            - name: Verify deploy package exists
              run: |
                  if [ -d "./deploy_pkg/app" ] && [ -f "./deploy_pkg/requirements.txt" ]; then
                    echo "Deploy package verified: app/ directory and requirements.txt found."
                  else
                    echo "::error::Deploy package is missing required files. Ensure app/ directory and requirements.txt are included in the artifact."
                    exit 1
                  fi
                  ls -la ./deploy_pkg

            - name: Deploy to Azure Web App
              uses: azure/webapps-deploy@v3
              id: deploy-to-webapp
              with:
                  app-name: ${{ steps.resolveapp.outputs.app_name }}
                  slot-name: "Production"
                  package: ./deploy_pkg
