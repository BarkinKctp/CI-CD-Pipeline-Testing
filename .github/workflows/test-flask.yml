name: Test Flask App

on:
    workflow_dispatch:
    pull_request:
        branches:
            - main
    push:
        branches:
            - main

jobs:
    test:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                python-version: [3.12]
        steps:
            - name: Create GitHub App token
              id: app
              uses: actions/create-github-app-token@v1
              with:
                  app-id: ${{ vars.GH_APPLICATION_ID }}
                  private-key: ${{ secrets.GH_APP_KEY }}
                  owner: ${{ github.repository_owner }}

            - name: Check out repository
              uses: actions/checkout@v4
              with:
                  token: ${{ steps.app.outputs.token }}

            - name: Use token (gh / curl / etc.)
              env:
                  GH_TOKEN: ${{ steps.app.outputs.token }}
              run: |
                  gh api repos/${{ github.repository }} --jq '.full_name'

            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v4
              with:
                  python-version: ${{ matrix.python-version }}

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt

            - name: Run tests
              id: unit_tests
              run: |
                  python -m unittest app/main_test.py

            - name: Write test result file
              if: always()
              run: |
                  mkdir -p results

                  TEST_STATUS="failure"
                  if [ "${{ steps.unit_tests.outcome }}" = "success" ]; then
                    TEST_STATUS="success"
                  fi

                  RESULT_FILE="results/test-flask-${GITHUB_RUN_ID}.md"
                  {
                    echo "# Test Flask Workflow Result"
                    echo
                    echo "- Status: ${TEST_STATUS}"
                    echo "- Repository: ${GITHUB_REPOSITORY}"
                    echo "- Branch/Ref: ${GITHUB_REF}"
                    echo "- Run ID: ${GITHUB_RUN_ID}"
                    echo "- Run Number: ${GITHUB_RUN_NUMBER}"
                    echo "- Workflow: ${GITHUB_WORKFLOW}"
                  } > "$RESULT_FILE"

                  echo "Wrote test result to $RESULT_FILE"
                  ls -la results

            - name: Push results to private repo
              if: always() && github.event_name != 'pull_request'
              continue-on-error: true
              timeout-minutes: 5
              shell: bash
              env:
                  GH_TOKEN: ${{ steps.app.outputs.token }}
                  TARGET_REPO: BarkinKctp/ghapp-oidc-deploy-test
                  TARGET_BRANCH: main
              run: |

                  set -Eeuo pipefail

                  die() { echo "::error::$*"; exit 1; }

                  SRC_FILE="results/test-flask-${GITHUB_RUN_ID}.md"
                  if [ -z "$GH_TOKEN" ]; then
                    die "GH_TOKEN is not set."
                  fi
                  if [ ! -f "$SRC_FILE" ]; then
                    die "Source file $SRC_FILE does not exist."
                  fi

                  WORK_DIR=$(mktemp -d)
                  cleanup() {
                    rm -rf "$WORK_DIR"
                  }
                  trap cleanup EXIT

                  echo "Cloning target repository $TARGET_REPO into $WORK_DIR"
                    git clone --depth 1 --branch "$TARGET_BRANCH" \
                    "https://x-access-token:${GH_TOKEN}@github.com/${TARGET_REPO}.git" "$WORK_DIR" \
                    || die "Failed to clone repository." 

                  mkdir -p "$WORK_DIR/results"
                  cp "$SRC_FILE" "$WORK_DIR/results/" || die "Failed to copy result file."

                  cd "$WORK_DIR"
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

                  git add "results/$(basename "$SRC_FILE")"
                  if git diff --staged --quiet; then
                    echo "No changes to commit."
                    exit 0
                  fi

                  git commit -m "Add test result for run $GITHUB_RUN_ID" \
                  || die "Failed to commit changes."

                  for i in {1..3}; do
                    if git push origin "$TARGET_BRANCH"; then
                      echo "Pushed test result to $TARGET_REPO successfully."
                      exit 0
                    else
                      echo "Failed to push changes. Attempt $i of 3."
                      sleep 5
                    fi
                  done

                  die "Failed to push changes after 3 attempts."
